<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Kurulumu - TonBot</title>
    
    <link rel="stylesheet" href="Style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- SETUP SAYFASINA Ã–ZEL STÄ°LLER --- */
        body { background-color: #f5f5f7; padding-top: 80px; min-height: 100vh; display: flex; flex-direction: column; }

        /* Header (Sadece Logo - Ã‡Ä±kÄ±ÅŸ Butonu yok, odakta kalsÄ±n) */
        .setup-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }
        .brand-logo { font-size: 1.5rem; font-weight: 800; color: #1D1D1F; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .logo-dot { width: 10px; height: 10px; background-color: #25D366; border-radius: 50%; }

        /* Ana Kutu */
        .wizard-container {
            width: 90%; max-width: 700px; margin: 40px auto; 
            background: white; border-radius: 24px; padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02);
        }

        /* Ä°lerleme Ã‡ubuÄŸu */
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .progress-line { position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #e5e5e5; z-index: 0; }
        .step { position: relative; z-index: 1; text-align: center; width: 33%; }
        .step-circle { 
            width: 32px; height: 32px; background: #e5e5e5; border-radius: 50%; margin: 0 auto 10px; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: #888; font-size: 0.9rem; transition: 0.3s;
        }
        .step-text { font-size: 0.85rem; color: #888; font-weight: 500; }
        
        /* Aktif AdÄ±m Stili */
        .active .step-circle { background: #007aff; color: white; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2); }
        .active .step-text { color: #007aff; font-weight: 600; }
        .completed .step-circle { background: #25D366; color: white; }

        /* Ä°Ã§erik AlanlarÄ± */
        .step-content { display: none; animation: fadeIn 0.5s ease; }
        .step-content.current { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.8rem; margin-bottom: 10px; color: #1d1d1f; text-align: center; font-weight: 700; }
        p { color: #86868b; text-align: center; margin-bottom: 30px; }

        /* QR AlanÄ± */
        #qr-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; }
        #qr-box { padding: 20px; background: white; border: 1px solid #eee; border-radius: 12px; }
        .status-text { margin-top: 20px; font-weight: 600; color: #007aff; }

        /* Form ElemanlarÄ± */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: #1d1d1f; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 14px; border: 1px solid #d2d2d7; border-radius: 12px;
            font-size: 1rem; outline: none; font-family: 'Inter', sans-serif; box-sizing: border-box;
            background-color: #fbfbfd; transition: 0.2s;
        }
        .form-input:focus, .form-textarea:focus { border-color: #007aff; background: white; box-shadow: 0 0 0 4px rgba(0,122,255,0.1); }
        .form-textarea { height: 150px; resize: vertical; }

        /* Butonlar */
        .btn-next {
            width: 100%; padding: 16px; background: #007aff; color: white; border: none;
            border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s;
            margin-top: 10px;
        }
        .btn-next:hover { background: #005ecb; transform: translateY(-2px); }

        /* BaÅŸarÄ± EkranÄ± */
        .success-icon { font-size: 4rem; display: block; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header class="setup-header">
        <a href="#" class="brand-logo">
            <span class="logo-dot"></span> TonBot
        </a>
    </header>

    <div class="wizard-container">
        
        <div class="progress-bar">
            <div class="progress-line"></div>
            <div class="step active" id="step-indicator-1">
                <div class="step-circle">1</div>
                <div class="step-text">BaÄŸlantÄ±</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-circle">2</div>
                <div class="step-text">EÄŸitim</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-circle">3</div>
                <div class="step-text">Bilgi</div>
            </div>
        </div>

        <div id="step-1" class="step-content current">
            <h2>WhatsApp'Ä± BaÄŸla</h2>
            <p>Telefonundan WhatsApp > Ayarlar > BaÄŸlÄ± Cihazlar menÃ¼sÃ¼nÃ¼ aÃ§.</p>
            
            <input type="text" id="session-id" class="form-input" placeholder="Ä°ÅŸletme AdÄ± (Ã–rn: butik_ayse)" style="text-align:center; margin-bottom:20px;">
            
            <button onclick="qrOlustur()" class="btn-next">QR Kod OluÅŸtur</button>

            <div id="qr-area" style="display:none;">
                <div id="qr-box"></div>
                <div class="status-text" id="status-msg">QR Bekleniyor...</div>
            </div>
        </div>

        <div id="step-2" class="step-content">
            <h2>Bot KimliÄŸi</h2>
            <p>AsistanÄ±nÄ±z mÃ¼ÅŸterilerinize nasÄ±l davransÄ±n?</p>

            <div class="form-group">
                <label>Botun AdÄ±</label>
                <input type="text" id="bot-name" class="form-input" placeholder="Ã–rn: AslÄ±, TonBot, Destek">
            </div>

            <div class="form-group">
                <label>KonuÅŸma TarzÄ±</label>
                <select id="bot-tone" class="form-select form-input">
                    <option value="Samimi ve bol emojili">ðŸ˜Š Samimi ve Emojili</option>
                    <option value="Kurumsal ve resmi">ðŸ‘” Kurumsal ve Resmi</option>
                    <option value="LÃ¼ks ve seÃ§kin">ðŸ’Ž LÃ¼ks ve SeÃ§kin</option>
                </select>
            </div>

            <button onclick="adimGec(3)" class="btn-next">Devam Et â†’</button>
        </div>

        <div id="step-3" class="step-content">
            <h2>Bilgi BankasÄ± ðŸ“š</h2>
            <p>ÃœrÃ¼nlerini, fiyatlarÄ±nÄ± ve linklerini buraya yapÄ±ÅŸtÄ±r. Bot buradan Ã¶ÄŸrenir.</p>

            <div class="form-group">
                <textarea id="knowledge-base" class="form-textarea" placeholder="Ã–rnek:
- KÄ±rmÄ±zÄ± Elbise: 500 TL. Link: site.com/kirmizi
- Kargo: 1000 TL Ã¼zeri bedava.
- Adres: KadÄ±kÃ¶y BoÄŸa heykeli yanÄ±.
- Ä°ade: 14 gÃ¼n iÃ§inde yapÄ±labilir."></textarea>
            </div>

            <button onclick="kaydetVeBitir()" class="btn-next" style="background-color: #25D366;">Kaydet ve BaÅŸlat ðŸš€</button>
        </div>

        <div id="step-success" class="step-content" style="text-align: center;">
            <span class="success-icon">ðŸŽ‰</span>
            <h2 style="color: #25D366;">Kurulum TamamlandÄ±!</h2>
            <p>Botunuz ÅŸu an aktif ve mesajlara cevap veriyor.</p>
            <a href="https://wa.me/" target="_blank" class="btn-next" style="display:inline-block; width:auto; padding: 15px 40px; text-decoration: none;">Test Et</a>
        </div>

    </div>

    <script>
        const socket = io(); 
        let currentSessionId = "";

        // --- ADIM 1: QR ---
        function qrOlustur() {
            const sid = document.getElementById('session-id').value;
            if(!sid) return alert("LÃ¼tfen bir isim girin (Ã–rn: butik_1)");
            
            currentSessionId = sid;
            
            // Butonu gizle, QR alanÄ±nÄ± aÃ§
            document.querySelector('button[onclick="qrOlustur()"]').style.display = 'none';
            document.getElementById('qr-area').style.display = 'flex';

            // Backend'e Sinyal GÃ¶nder
            socket.emit('start_session', { sessionId: currentSessionId });
        }

        // QR Gelince
        socket.on('qr', (qrCode) => {
            document.getElementById('qr-box').innerHTML = "";
            new QRCode(document.getElementById('qr-box'), { text: qrCode, width: 220, height: 220 });
            document.getElementById('status-msg').innerText = "LÃ¼tfen WhatsApp'tan Okutun";
        });

        // BaÄŸlanÄ±nca -> Otomatik 2. AdÄ±ma GeÃ§
        socket.on('status', (msg) => {
            if(msg === 'connected') {
                adimGec(2);
            }
        });

        // --- ADIM GEÃ‡Ä°ÅžLERÄ° ---
        function adimGec(adimNo) {
            // TÃ¼m iÃ§erikleri gizle
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('current'));
            // Ä°stenen adÄ±mÄ± gÃ¶ster
            document.getElementById(`step-${adimNo}`).classList.add('current');

            // Ãœstteki Ã§ubuÄŸu gÃ¼ncelle
            document.querySelectorAll('.step').forEach((el, index) => {
                if (index + 1 < adimNo) el.classList.add('completed'); // GeÃ§ilenler yeÅŸil
                if (index + 1 === adimNo) el.classList.add('active'); // Åžu anki mavi
            });
        }

        // --- KAYDETME (BACKEND BAÄžLANTISI) ---
        async function kaydetVeBitir() {
            const botName = document.getElementById('bot-name').value;
            const botTone = document.getElementById('bot-tone').value;
            const knowledge = document.getElementById('knowledge-base').value;

            // Yapay Zeka iÃ§in Promptu BirleÅŸtir
            const finalPrompt = `Senin adÄ±n ${botName}. Tonun ${botTone} olacak. Ä°ÅŸte bilmen gerekenler:\n\n${knowledge}`;

            const btn = document.querySelector('#step-3 .btn-next');
            const originalText = btn.innerText;
            btn.innerText = "Kaydediliyor...";

            try {
                const response = await fetch('/api/save-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        session_id: currentSessionId, 
                        prompt: finalPrompt 
                    })
                });

                if(response.ok) {
                    adimGec('success'); // BaÅŸarÄ± ekranÄ±na git
                } else {
                    alert("Hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
                    btn.innerText = originalText;
                }
            } catch (e) {
                console.error(e);
                alert("Sunucu hatasÄ±!");
                btn.innerText = originalText;
            }
        }
    </script>

</body>
</html>